<html>
  <head>
    <link rel="stylesheet" type="text/css" href="static/css/main.css" />
  </head>
  <body>
<h1>Open ERP logs</h1>
<div class="dups">
<h2>Duplicates</h2>
<table class="table table-striped table-bordered table-condensed">
<thead>
    <tr>
        <th class="prologue">Message</th>
        <th class="count">Messages</th>
        <th class="count">Time</th>
    </tr>
</thead>
<tbody id="duplicates">
</tbody>
</table>
</div>
<h2>Summary</h2>
<table class="table table-striped table-bordered table-condensed">
<thead>
    <tr>
        <th class="prologue">Prologue</th>
        <th class="count">Messages</th>
        <th class="time">Execute Time</th>
        <th class="time">First Message</th>
        <th class="time">Last Message</th>
    </tr>
</thead>
<tbody id="overview">
</tbody>
</table>
<h2>Messages</h2>
<table class="table table-striped table-bordered table-condensed">
<thead>
    <tr>
        <th class="req_start">Start</th>
        <th class="req">Request</th>
        <th class="res">Response</th>
        <th class="time">Execute Time</th>
    </tr>
</thead>
<tbody id="entries">
</tbody>
</table>

<script type="text/javascript" src="modules.js"></script>
<script type="text/javascript">
    var db = require('db').current();
    var $ = require('jquery');

    db.getView('mulch', 'messages', { descending: 'true' }, function (err, data) {
        if (err) {
            // an error occurred
            return alert(err);
        }
        for (var i = 0; i < data.rows.length; i++) {
            var row = $('<tr>');
            var data_row = data.rows[i].value;
            var request_start = data_row.request_start;
            $('<td class="req_start">').text(request_start).appendTo(row);
            var col = $('<td class="req">');
            var request_text = data_row.request.join("\n");
            $('<pre>').text(request_text).appendTo(col);
            col.appendTo(row);
            col = $('<td class="res">');
            $('<pre>').text(data_row.response.join("\n")).appendTo(col);
            col.appendTo(row);
            $('<td class="time">').text(data_row.response_time).appendTo(row);
            row.appendTo('#entries');
        }
    });
    db.getView('mulch', 'message_types', { group: 'true', descending: 'true' }, function (err, data) {
        if (err) {
            // an error occurred
            return alert(err);
        }
        for (var i = 0; i < data.rows.length; i++) {
            var row = $('<tr>');
            var key = data.rows[i].key;
            var info = data.rows[i].value;
            $('<td class="prologue">').text(key[1]).appendTo(row);
            $('<td class="count">').text(info.count).appendTo(row);
            $('<td class="time">').text(Math.round(info.response_time*1000)/1000 + 's').appendTo(row);
            $('<td class="time">').text(info.first_request).appendTo(row);
            $('<td class="time">').text(info.last_request).appendTo(row);
            row.appendTo('#overview');
        }
    });
    db.getView('mulch', 'duplicates', { group: 'true', descending: 'true' }, function (err, data) {
        if (err) {
            // an error occurred
            return alert(err);
        }
        var duplicates = 0;
        for (var i = 0; i < data.rows.length; i++) {
            var row = data.rows[i].value;
            if(row.count > 1) {
                duplicates++;
                var key = data.rows[i].key;
                var table_row = $('<tr>');
                var col = $('<td>');
                $('<pre>').text(key[1].join("\n")).appendTo(col);
                col.appendTo(table_row);
                $('<td class="count">').text(row.count).appendTo(table_row);
                $('<td class="time">').text(Math.round(row.response_time*1000)/1000 + 's').appendTo(table_row);
                table_row.appendTo('#duplicates');
            }
        }
        if(!duplicates) {
            $('.dups').remove();
        }
    });
</script>
</body>
</html>

