<html>
  <head>
    <link rel="stylesheet" type="text/css" href="static/css/main.css" />
  </head>
  <body>
<h1>Open ERP logs</h1>
<h2>Duplicates</h2>
<table class="table table-striped table-bordered table-condensed">
<thead>
    <tr>
        <th class="prologue">Message</th>
        <th class="count">Messages</th>
    </tr>
</thead>
<tbody id="duplicates">
</tbody>
</table>
<h2>Summary</h2>
<table class="table table-striped table-bordered table-condensed">
<thead>
    <tr>
        <th class="prologue">Prologue</th>
        <th class="count">Messages</th>
        <th class="time">Execute Time</th>
    </tr>
</thead>
<tbody id="overview">
</tbody>
</table>
<h2>Messages</h2>
<table class="table table-striped table-bordered table-condensed">
<thead>
    <tr>
        <th class="req_start">Start</th>
        <th class="prologue">Prologue</th>
        <th class="req">Request</th>
        <th class="res">Response</th>
        <th class="time">Execute Time</th>
    </tr>
</thead>
<tbody id="entries">
</tbody>
</table>

<script type="text/javascript" src="modules.js"></script>
<script type="text/javascript">
    var db = require('db').current();
    var $ = require('jquery');

    db.getView('mulch', 'messages', { descending: 'true' }, function (err, data) {
        if (err) {
            // an error occurred
            return alert(err);
        }
        var instructions = {};
        var duplicates = {};
        for (var i = 0; i < data.rows.length; i++) {
            var row = $('<tr>');
            var data_row = data.rows[i].value;
            var key = data.rows[i].key;
            var prologue = key[2];
            if(prologue) {
                var message_info = instructions[prologue] || { count: 0, time: 0 };
                message_info['count']++;
                message_info['time'] += Number(data_row.response_time.replace(/s/, ''));
                instructions[prologue] = message_info;
            }
            var request_start = data_row.request_start;
            $('<td class="req_start">').text(request_start).appendTo(row);
            if(duplicates[request_start]) {
                duplicates[request_start]++;
            } else {
                duplicates[request_start] = 1;
            }
            var col = $('<td class="req">');
            $('<pre>').text(data_row.request.join("\n")).appendTo(col);
            col.appendTo(row);
            col = $('<td class="res">');
            $('<pre>').text(data_row.response.join("\n")).appendTo(col);
            col.appendTo(row);
            $('<td class="time">').text(data_row.response_time).appendTo(row);
            row.appendTo('#entries');
        }
        for(k in instructions) {
            if(k) {
                var row = $('<tr>');
                var info = instructions[k];
                $('<td class="prologue">').text(k).appendTo(row);
                $('<td class="count">').text(info.count).appendTo(row);
                $('<td class="time">').text(Math.round(info.time*1000)/1000 + 's').appendTo(row);
                row.appendTo('#overview');
            }
        }
        for(req in duplicates) {
            var count = duplicates[req];
            if(count > 1) {
                var row = $('<tr>');
                var col = $('<td>');
                $('<pre>').text(req).appendTo(col);
                col.appendTo(row);
                $('<td>').text(count).appendTo(row);
                row.appendTo('#duplicates');
            }
        }
    });
</script>
</body>
</html>

